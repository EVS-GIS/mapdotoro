---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# mapdotoro

<!-- badges: start -->
<!-- badges: end -->

Mapdotoro aim to prepared the Fluvial Corridor Toolbox data outputs to the shiny application mapdoapp.

## Installation

You can install the development version of mapdotoro from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("EVS-GIS/mapdotoro")
```

## Workflow

Testing dataset can be found

```{r, eval = FALSE}
library(dplyr)
library(sf)
library(tmap)
library(mapdotoro)
library(tidyr)
library(lwgeom)
library(qgisprocess)

data(bassin_hydrographique)
data(region_hydrographique)
data(referentiel_hydro)
data(swaths)
data(talweg_metrics)
data(landcover)
```

set geometry column name
```{r, eval = FALSE}
st_geometry(bassin_hydrographique) <- "geometry"
st_geometry(region_hydrographique) <- "geometry"
st_geometry(referentiel_hydro) <- "geometry"
st_geometry(swaths) <- "geometry"
```


Map dataset
```{r, eval = FALSE}
tmap::tmap_mode("view")
map <- tmap::tm_shape(bassin_hydrographique) +
  tmap::tm_polygons()+
tmap::tm_shape(region_hydrographique) +
  tmap::tm_polygons()+
tmap::tm_shape(swaths) +
  tmap::tm_polygons()+
tmap::tm_shape(referentiel_hydro) +
  tmap::tm_lines(col= "blue")
map
```

clean swaths
```{r, eval = FALSE}
swaths_data <- swaths %>% 
  dplyr::filter(VALUE == 2) # keep only valid swaths

duplicated_swaths <- check_duplicate(swaths_data)
cleaned_swaths <- clean_duplicated(dataset = swaths_data,
                                   duplicated_dataset = duplicated_swaths)
  # dplyr::mutate(id = row_number())
```

clip referentiel hydro by swaths
```{r, eval = FALSE}
hydro_swaths <- st_sf(st_sfc(crs = 2154)) # create an empty sf dataset
# clip by axis
for (axis in unique(cleaned_swaths$AXIS)){
  swaths_axe <- cleaned_swaths %>%
    filter(AXIS == axis) # get swaths by axis
  hydro_axe <- referentiel_hydro %>%
    filter(AXIS == axis) %>% # get streams by axis
    st_zm () %>% 
    st_combine() %>% 
    st_sf() %>% 
    st_line_merge()
  hydro_swaths_axis <- hydro_axe %>% 
    st_split(swaths_axe) %>%
    st_collection_extract("LINESTRING") %>%
    st_join(swaths_axe, join = st_within) %>% 
    mutate(AXIS = ifelse(is.na(AXIS), axis, AXIS))
  hydro_swaths <- rbind(hydro_swaths, hydro_swaths_axis) # fill the output dataset by axis
}

```

clean hydro_swaths
```{r, eval = FALSE}
hydro_swaths_len <- hydro_swaths %>%
  mutate(id = row_number()) %>% 
  mutate(LENG = st_length(.))
  # mutate(M = ifelse(LENG < units::set_units(10, m), NA, M)) # length is unit object

hydro_swaths_len_dupl <- check_duplicate(hydro_swaths_len)

hydro_swaths_len_dupl_corr <- st_sf(st_sfc(crs = 2154)) # create an empty sf dataset
for (measure in unique(hydro_swaths_len_dupl$M)){
  hydro_swaths_len_dupl_measure <- hydro_swaths_len_dupl %>% 
    filter(M == measure) %>% 
    filter(LENG < max(LENG)) %>% 
    mutate(M = -1)
  hydro_swaths_len_dupl_corr <- rbind(hydro_swaths_len_dupl_corr, hydro_swaths_len_dupl_measure)
}

hydro_swaths_len_dupl_corr <- hydro_swaths_len_dupl_corr %>%
  st_drop_geometry() %>% 
  select (id, M)

merged_hydro_swaths <- merge(hydro_swaths_len, hydro_swaths_len_dupl_corr, by = "id", all.x = TRUE) %>% 
  mutate(M.x = ifelse(!is.na(M.y) & M.y == -1, NA, M.x)) %>% 
  select(-M.y) %>% 
  rename("M" = M.x) %>% 
  select(AXIS, M, DRAINAGE, geometry)
```

Measure network from outlet
```{r, eval = FALSE}
identifynetworknodes <- merged_hydro_swaths %>% 
  qgis_run_algorithm_p("fct:identifynetworknodes",
                       QUANTIZATION = 100000000)

hydro_swaths_identified <- st_read(identifynetworknodes$OUTPUT) %>% 
  filter(NODEA != NODEB) # remove row when NODEA = NODEB (when distance is too short the node id is the same)

measurenetworkfromoutlet <- hydro_swaths_identified %>% 
  qgis_run_algorithm_p("fct:measurenetworkfromoutlet",
                       FROM_NODE_FIELD = "NODEA",
                       TO_NODE_FIELD = "NODEB")

hydro_swaths_measured <- st_read(measurenetworkfromoutlet$OUTPUT) %>% 
  st_zm()

# st_write(hydro_swaths_measured, dsn = "data-raw/temp/hydro_swaths_measured.gpkg", layer = "hydro_swaths_measured", delete_dsn = TRUE)

```

Add talweg metrics to swaths
```{r, eval = FALSE}
swath_join_landcover <- cleaned_swaths %>% 
  dplyr::inner_join(landcover, by = c("M"="measure", "AXIS"="axis"))
```

Add landcover to swaths
```{r, eval = FALSE}
landcover_prepared <- swath_join_landcover %>% 
  sf::st_drop_geometry() %>%
  dplyr::mutate(area_ha = area/10000) %>%  # convert m2 to ha
  dplyr::select(id, label, area_ha) %>% 
  tidyr::pivot_wider(names_from = label, values_from = area_ha) %>% 
  rename_with(~stringr::str_replace_all(., " ", "_"), everything())%>%
  mutate(sum_area = rowSums(select(., Crops, Dense_Urban, Diffuse_Urban,
                                              Forest, Grassland, Gravel_Bars,
                                              Infrastructures, Natural_Open,
                                              Water_Channel), na.rm = TRUE))
```













